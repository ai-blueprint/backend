# 蓝图执行引擎 (Blueprint Engine) 零基础保姆级文档

你好！如果你完全不懂 Python，甚至没写过代码，请千万不要关掉这个页面。
这个项目就像是一个“乐高积木”的自动化工厂，而你就是这个工厂的新任厂长。
为了让你能彻底听懂、看懂并学会操作，我把这份文档写得非常长，且分成了三个阶段。
**速读**让你知道工厂是干嘛的，**粗读**教你认识工厂里的零件，**精读**则带你拆解工厂的每一台机器。
请记住：每读完一小段，你都会离“Python 高手”更近一步。

---

## 第一部分：速读 (Quick Start) —— 3分钟看懂全局

### 1. 这个项目到底在做什么？
想象一下，你手里有一堆功能不同的“乐高积木”：有的积木负责“加法”，有的负责“变色”。
在前端（网页上），用户把这些积木摆好，并用线连起来，形成一个复杂的“流水线”。
而我们这个后端项目，就是这个流水线的“大脑”。
它负责读懂用户连好的线，把数据从第一个积木传到第二个积木，直到算出最终结果。

### 2. 核心概念深度解析（附：理解误区）
- **节点 (Node)**：它是工厂里的“工人”。每个工人只干一件事（比如只负责把数字翻倍）。
  - *理解误区*：不要以为节点是活的，它其实只是一段死代码，只有引擎叫它干活时它才动。
- **端口 (Port)**：它是工人手里的“接货口”和“出货口”。左边接原材料，右边出成品。
  - *理解误区*：端口不是随便连的，接货口只能接它能处理的东西，你不能给榨汁机喂石头。
- **连线 (Edge)**：它是工厂里的“传送带”。它决定了原材料从哪个工人流向下一个工人。
  - *理解误区*：连线本身不产生数据，它只是数据的搬运工，线断了，工厂就停工了。
- **蓝图 (Blueprint)**：它是整张“施工图纸”。它告诉引擎：一共有多少工人，他们是怎么连线的。
  - *理解误区*：蓝图不是程序，它只是一张纸（JSON文件），引擎才是执行者。
- **引擎 (Engine)**：它是工厂的“总调度员”。它负责看图纸，点名让工人按顺序干活。
  - *理解误区*：引擎不生产数据，它只负责“叫号”和“搬运”，真正的活是节点干的。

### 3. 怎么让它动起来？
首先，你需要安装 Python（就像给电脑装个操作系统）。
然后，打开你的黑窗口（终端），输入 `pip install torch`（这是给工厂买原材料）。
接着，输入 `python main.py`，如果看到 "Hello from backend!"，说明工厂通电了。
最后，运行 `python test_engine.py`，你会看到引擎是如何按照图纸跑完整个流程的。
恭喜你，你已经完成了“厂长入职培训”的第一步！

---

## 第二部分：粗读 (Deep Dive - Overview) —— 零基础 Python 补课

### 1. 像说话一样学 Python
如果你觉得代码很难，那是因为你把它当成了数学，其实它更像英语。
**变量 (Variable)**：它就是一个“便利贴”。
比如 `name = "张三"`，就是把“张三”这个名字贴在 `name` 这个便利贴上。
以后你只要喊 `name`，电脑就知道你在叫“张三”。
*理解误区*：变量名不能乱起，虽然你可以叫它 `a123`，但最好叫它 `user_name`，否则明天你自己都看不懂。

**函数 (Function)**：它就是一个“自动售货机”。
你塞进硬币（输入参数），它吐出可乐（返回值）。
在代码里，我们用 `def` 来定义一个售货机，比如 `def make_juice(fruit):`。
*理解误区*：函数定义了不代表它运行了，你得“按按钮”（调用它）它才会动。

**类 (Class)**：它就是一个“模具”。
比如“月饼模具”，它可以印出五仁月饼、豆沙月饼。
模具本身不能吃，但印出来的“月饼”（对象）可以吃。
在本项目中，`BlueprintEngine` 就是一个模具，用来制造具体的“执行引擎”。
*理解误区*：类和对象是两回事，类是图纸，对象是根据图纸造出来的实物。

**装饰器 (Decorator)**：它就是一个“外卖包装盒”。
你的函数是里面的“炸鸡”，装饰器就是外面的“盒子”。
盒子可以让炸鸡看起来更高级，或者给炸鸡保温（增加功能）。
在代码里，看到 `@node`，就说明这个函数被装进了“节点包装盒”里。
*理解误区*：装饰器不会改变炸鸡的味道（函数核心逻辑），它只是在外面加点料。

### 2. 认识项目里的“部门”
- `engine.py`（调度部）：它是最忙的，负责看图纸、搬东西、叫人干活。
- `registry.py`（人事部）：它手里有一份名单，记录了工厂里所有工人的信息。
- `loader.py`（招聘部）：它负责去 `nodes/` 宿舍区把所有睡觉的工人都叫醒。
- `decorators.py`（制服部）：它给每个工人发制服（装饰器），方便人事部识别。
- `nodes/`（员工宿舍）：这里住着所有的功能节点，每个文件都是一个宿舍。

---

## 第三部分：精读 (Mastery - Code Analysis) —— 核心机器拆解

### 1. 调度员的工作手册：`engine.py`
调度员（引擎）拿到图纸后，第一件事是“排队”（拓扑排序）。
他会看：哪个工人不需要别人的东西就能开工？（比如输入节点）。
然后他会把这些工人排在前面，把依赖他们的工人排在后面。
*理解误区*：排队不是按节点在 JSON 里的顺序，而是按连线的逻辑顺序。
如果 A 连向 B，那 A 必须排在 B 前面，否则 B 开工时拿不到 A 的东西。

排好队后，调度员会依次走到每个工人面前，做三件事：
1. **量尺寸 (infer)**：问工人“你产出的东西多大尺寸？”，工人根据输入告诉他尺寸。
2. **搬机器 (build)**：如果工人需要大型机器（PyTorch层），调度员帮他搬来并装好。
3. **开工 (compute)**：调度员把原材料递给工人，工人算出成品，调度员拿走成品。
*理解误区*：`build` 只在第一次开工时做，以后再开工就直接用装好的机器了。

### 2. 数据的一生：从输入到输出
想象数据是一块“原材料”，它在工厂里流转时会被加工成各种形状。
在本项目中，数据通常以 `Tensor`（张量）的形式存在，你可以把它看作是一组整齐排列的数字。
当数据流过一个“加法节点”时，它会被加上另一个数字；流过“激活节点”时，它会被过滤掉负数。
调度员（引擎）会全程盯着这块原材料，确保它准确无误地从一个工位传送到下一个工位。
*理解误区*：数据不是存在连线里的，连线只是路径，数据实际上是存在引擎的“临时仓库”（results字典）里的。

### 2. 招聘部的秘密：`loader.py`
招聘部（加载器）非常聪明，他不需要你手动告诉他有哪些工人。
他会自己去 `nodes/` 宿舍区转悠，只要看到 `.py` 结尾的文件，就进去看看。
如果发现里面有穿“制服”（装饰器）的工人，就立刻把他们登记在案。
*理解误区*：如果你写了一个新工人但没穿制服（没加装饰器），招聘部是看不见他的。
所以，写完新节点一定要记得加上 `@node`，否则他永远无法上岗。

### 3. 手把手教你写第一个节点（避坑指南）
第一步：在 `nodes/` 下新建文件 `my_node.py`。
第二步：复制 `base.py` 里的格式，改掉 `opcode` 和 `name`。
第三步：在 `compute` 函数里写你的逻辑，比如 `return x * 2`。
*避坑指南*：千万不要在 `compute` 里写耗时太长的操作，否则整个工厂都会卡死。
另外，确保你的输入端口名字和前端传过来的一模一样，错一个字母都接不到货。

恭喜你，厂长！你已经读完了这份超长文档。
现在的你，已经具备了接手并完善这个工厂的所有理论知识。
不要害怕犯错，代码写错了电脑不会爆炸，大不了重启一下。
去吧，去创造属于你的自动化蓝图世界！
如果你还有哪里听不懂，记得回头再看一遍“粗读”部分的便利贴类比。
